name: Export Google Doc to PDF (Node.js)

on:
  workflow_dispatch:

jobs:
  export-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install Google API Dependencies
        run: npm install googleapis

      - name: Download PDF from Google Docs
        env:
          GOOGLE_DOC_ID: '1GDbZdAt_XJRGRc7bLSy9uFlm1ww8lsfnlwDahnfD9GQ'
          OUTPUT_FILENAME: './fles.ch/john-flesch-staff-engineer-2026.pdf'
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        run: |
          cat <<EOF > export-google-doc.js
          import fs from "node:fs";
          import { google } from "googleapis";

          try {
            const credentials = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT);

            const auth = new google.auth.GoogleAuth({
              credentials,
              scopes: ["https://www.googleapis.com/auth/drive.readonly"],
            });

            const drive = google.drive({ version: "v3", auth });

            const fileId = process.env.GOOGLE_DOC_ID;
            const destination = process.env.OUTPUT_FILENAME;

            const response = await drive.files.export({
              fileId: fileId,
              mimeType: "application/pdf",
            }, { responseType: "stream" });

            const document = fs.createWriteStream(destination);
            
            await new Promise((resolve, reject) => {
              response.data
                .on("end", () => {
                  console.log("Download complete.");
                  resolve();
                })
                .on("error", err => {
                  console.error("Error during download stream:", err);
                  reject(err);
                })
                .pipe(document);
            });
          } catch (error) {
            console.error("Script failed:", error);
            process.exit(1);
          }
          EOF
          
          node export-google-doc.js

      - name: Create PDF preview image
        run: |
          sudo apt-get update
          sudo apt-get install --yes poppler-utils webp
          pdftoppm -png -f 1 -singlefile ./fles.ch/john-flesch-staff-engineer-2026.pdf ./fles.ch/temp
          cwebp -q 100 ./fles.ch/temp.png -o ./fles.ch/john-flesch-staff-engineer-2026.webp
          rm ./fles.ch/temp.png

      - name: Commit and Push PDF
        id: commit
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add ./fles.ch/john-flesch-staff-engineer-2026.pdf
          git add ./fles.ch/john-flesch-staff-engineer-2026.webp
          
          # Check if there are changes before committing
          if git diff --cached --quiet; then
            echo 'No changes to the PDF. Skipping commit.'
            echo 'changed=false' >> $GITHUB_OUTPUT
          else
            git commit --message 'chore: update john-flesch-staff-engineer-2026.pdf and preview from Google Docs'
            git push
            echo 'changed=true' >> $GITHUB_OUTPUT
          fi

      - name: Trigger deployment
        if: steps.commit.outputs.changed == 'true'
        run: gh workflow run static.yml
        env:
          GH_TOKEN: ${{ github.token }}
